{% extends "base.html" %}

{% block content %}
<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="mb-0">Your API Keys</h2>
    <form method="POST" action="{{ url_for('apikeyblue.generateapikey') }}">
      <button type="submit" class="btn btn-primary">
        <i class="bi bi-plus-circle"></i> Generate New Key
      </button>
    </form>
  </div>

  <div class="table-responsive">
    <table id="apikeys-table" class="table table-striped table-bordered align-middle">
      <thead class="table-light">
        <tr>
          <th>API Key</th>
          <th>Created At</th>
          <th>Active</th>
          <th class="text-center">Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for key in api_keys %}
        <tr data-id="{{ key.id }}">
          <td><code>{{ key.api_key }}</code></td>
          <td>{{ key.created_at.strftime('%Y-%m-%d %H:%M:%S') if key.created_at else '' }}</td>
          <td class="text-center">
            <div class="form-check form-switch d-inline-block">
              <input class="form-check-input toggle-active" type="checkbox" data-id="{{ key.id }}"
                     {% if key.active %}checked{% endif %}>
            </div>
          </td>
          <td class="text-center">
            <button class="btn btn-sm btn-outline-danger delete-key" data-id="{{ key.id }}">
              <i class="bi bi-trash"></i> Delete
            </button>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}

{% block extra_js %}

<script>
  $(document).ready(function () {
    $('#apikeys-table').DataTable({
      order: [[1, 'desc']],
      pageLength: 10,
    });

    // Toggle active/inactive
    $('.toggle-active').on('change', function () {
      const keyId = $(this).data('id');
      $.post(`/toggle_apikey/${keyId}`, {}, function (res) {
        if (!res.success) alert('Failed to update key status');
      });
    });

    // Delete key
    $('.delete-key').on('click', function () {
      const keyId = $(this).data('id');
      if (confirm('Are you sure you want to delete this API key?')) {
        $.post(`/delete_apikey/${keyId}`, {}, function (res) {
          if (res.success) {
            $(`tr[data-id="${keyId}"]`).fadeOut(300, function () {
              $(this).remove();
            });
          } else {
            alert('Failed to delete key.');
          }
        });
      }
    });
  });
</script>
{% endblock %}
