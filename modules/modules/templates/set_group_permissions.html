{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <div class="card">
        <div class="card-header bg-primary text-white">
            <h3 class="card-title mb-0">Set Group Permissions</h3>
        </div>
        <div class="card-body">
            <form id="permissionsForm" method="POST">
                <input type="hidden" name="group_id" value="{{ group_id }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                
                <div class="table-responsive">
                    <table id="permissionsTable" class="table table-striped table-bordered" style="width:100%">
                        <thead>
                            <tr>
                                <th>Module</th>
                                <th class="text-center">Create</th>
                                <th class="text-center">Read</th>
                                <th class="text-center">Update</th>
                                <th class="text-center">Delete</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for module in modules %}
                            <tr>
                                <td>
                                    <div class="form-check">
                                        <input class="form-check-input module-check" 
                                               type="checkbox" 
                                               id="module_{{ module.name }}" 
                                               name="modules[]" 
                                               value="{{ module.name }}"
                                               {% if module.name in current_permissions %}checked{% endif %}>
                                        <label class="form-check-label" for="module_{{ module.name }}">
                                            {{ module.name }}
                                        </label>
                                    </div>
                                </td>
                                <td class="text-center">
                                    <input class="form-check-input crud-check" 
                                           type="checkbox" 
                                           name="create_{{ module.name }}"
                                           {% if current_permissions.get(module.name, {}).create %}checked{% endif %}>
                                </td>
                                <td class="text-center">
                                    <input class="form-check-input crud-check" 
                                           type="checkbox" 
                                           name="read_{{ module.name }}"
                                           {% if current_permissions.get(module.name, {}).read %}checked{% endif %}>
                                </td>
                                <td class="text-center">
                                    <input class="form-check-input crud-check" 
                                           type="checkbox" 
                                           name="update_{{ module.name }}"
                                           {% if current_permissions.get(module.name, {}).update %}checked{% endif %}>
                                </td>
                                <td class="text-center">
                                    <input class="form-check-input crud-check" 
                                           type="checkbox" 
                                           name="delete_{{ module.name }}"
                                           {% if current_permissions.get(module.name, {}).delete %}checked{% endif %}>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <div class="mt-3">
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-save"></i> Save Permissions
                    </button>
                    <a href="{{ url_for('groups.list_groups') }}" class="btn btn-secondary">
                        <i class="bi bi-x-circle"></i> Cancel
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>

{% block scripts %}
<script>
$(document).ready(function() {
    // Initialize DataTable
    $('#permissionsTable').DataTable({
        paging: false,
        searching: true,
        ordering: true,
        info: false,
        columnDefs: [
            { orderable: false, targets: [1, 2, 3, 4] }
        ]
    });

    // Enable/disable CRUD checkboxes based on module selection
    $('.module-check').change(function() {
        const row = $(this).closest('tr');
        const crudChecks = row.find('.crud-check');
        crudChecks.prop('disabled', !this.checked);
    });

    // Initialize state on page load
    $('.module-check').each(function() {
        const row = $(this).closest('tr');
        const crudChecks = row.find('.crud-check');
        crudChecks.prop('disabled', !this.checked);
    });
});
</script>
{% endblock %}
{% endblock %}